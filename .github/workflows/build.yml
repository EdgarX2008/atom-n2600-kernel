name: Atom N2600 - Kernel FINAL (INFALIBLE)

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version'
        required: true
        default: '6.1.113'

env:
  WORKDIR: ${{ github.workspace }}/kernel-build

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - name: Instalar dependencias
        run: sudo apt update && sudo apt install -y build-essential bc bison flex libncurses-dev libssl-dev libelf-dev dwarves openssl xz-utils cpio wget

      - name: Variables
        run: echo "KERNEL_VERSION=${{ inputs.kernel_version }}" >> $GITHUB_ENV

      - name: Descargar y extraer
        run: |
          mkdir -p $WORKDIR && cd $WORKDIR
          wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KERNEL_VERSION.tar.xz
          tar xf linux-$KERNEL_VERSION.tar.xz

      - name: Clave de firma
        run: |
          cd $WORKDIR
          mkdir -p certs
          openssl req -new -x509 -newkey rsa:2048 -keyout certs/signing_key.pem -out certs/signing_key.x509 -nodes -days 1 -subj "/CN=Atom N2600"

      - name: Configurar kernel
        run: |
          cd $WORKDIR/linux-$KERNEL_VERSION
          make defconfig
          ./scripts/config --set-str CONFIG_LOCALVERSION "-atom-n2600"
          ./scripts/config --enable CONFIG_MATOM
          ./scripts/config --set-val CONFIG_NR_CPUS 2
          ./scripts/config --set-val CONFIG_HZ 250
          ./scripts/config --module CONFIG_DRM_GMA500
          ./scripts/config --enable CONFIG_DRM CONFIG_DRM_KMS_HELPER CONFIG_FB CONFIG_FRAMEBUFFER_CONSOLE
          ./scripts/config --enable CONFIG_BACKLIGHT_CLASS_DEVICE CONFIG_BACKLIGHT_LCD_SUPPORT
          ./scripts/config --enable CONFIG_R8169 CONFIG_SND_HDA_INTEL CONFIG_SND_HDA_CODEC_REALTEK
          ./scripts/config --module CONFIG_RTL8192SE
          ./scripts/config --enable CONFIG_USB_UHCI_HCD CONFIG_USB_EHCI_HCD CONFIG_SATA_AHCI CONFIG_PMC_ATOM
          ./scripts/config --enable CONFIG_MODULE_SIG CONFIG_MODULE_SIG_FORCE
          ./scripts/config --set-str CONFIG_MODULE_SIG_KEY "certs/signing_key.pem"
          ./scripts/config --enable CONFIG_CC_STACKPROTECTOR_STRONG CONFIG_RANDOMIZE_BASE CONFIG_SECCOMP_FILTER CONFIG_STRICT_DEVMEM
          ./scripts/config --disable CONFIG_DEBUG_INFO
          make olddefconfig

      - name: Compilar
        run: |
          cd $WORKDIR/linux-$KERNEL_VERSION
          cp ../certs/signing_key.* .
          make -j2 bzImage modules

      - name: Empaquetar (con printf → NUNCA falla)
        run: |
          cd $WORKDIR/linux-$KERNEL_VERSION
          VER=$(make -s kernelrelease)
          mkdir -p ../package/boot ../package/scripts
          cp arch/x86/boot/bzImage ../package/boot/vmlinuz-$VER
          make INSTALL_MOD_PATH=../package modules_install
          echo "$VER" > ../package/kernel-version.txt

          printf '%b\n' \
            '#!/bin/bash' \
            'set -e' \
            'VER=\( (cat " \)(dirname "$0")/../kernel-version.txt")' \
            '[ "$EUID" != "0" ] && { echo "Ejecutar como root: sudo $0"; exit 1; }' \
            'cp "$(dirname "$0")/../boot/vmlinuz-$VER" /boot/' \
            'cp -r "$(dirname "$0")/../lib/modules/$VER" /lib/modules/' \
            'echo "gma500_gfx" | sudo tee /etc/modules-load.d/gma500.conf > /dev/null' \
            'sudo update-initramfs -c -k "$VER"' \
            'sudo update-grub' \
            'echo "¡Listo! Reinicia y elige el kernel $VER"' \
            > ../package/scripts/install.sh

          chmod +x ../package/scripts/install.sh
          cd .. && tar czf atom-n2600-$KERNEL_VERSION.tar.gz package

      - name: Subir
        uses: actions/upload-artifact@v4
        with:
          name: atom-n2600-$KERNEL_VERSION
          path: ${{ env.WORKDIR }}/atom-n2600-*.tar.gz