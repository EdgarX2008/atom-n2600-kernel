name: Build Secure Kernel for Intel Atom N2600

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version'
        required: true
        default: '6.1.113'

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  WORKDIR: ${{ github.workspace }}/kernel-build

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:  
      - name: Checkout repository
        uses: actions/checkout@v4  

      - name: Install dependencies  
        run: |
          sudo apt update && sudo apt install -y \
            build-essential bc bison flex libncurses-dev \
            libssl-dev libelf-dev dwarves openssl xz-utils cpio wget

      - name: Download and extract kernel  
        run: |  
          mkdir -p $WORKDIR && cd $WORKDIR  
          wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz  
          tar xf linux-${{ env.KERNEL_VERSION }}.tar.xz  

      - name: Generate ephemeral signing key  
        run: |  
          cd $WORKDIR  
          mkdir -p certs  
          openssl req -new -x509 -newkey rsa:2048 \
            -keyout certs/signing_key.pem -out certs/signing_key.x509 \
            -nodes -days 1 -subj "/CN=Atom N2600 Secure Build"

      - name: Configure kernel  
        run: |  
          cd $WORKDIR/linux-${{ env.KERNEL_VERSION }}  
          make defconfig

          ./scripts/config --set-str CONFIG_LOCALVERSION "-atom-n2600-secure"  
          ./scripts/config --enable CONFIG_MATOM  
          ./scripts/config --set-val CONFIG_NR_CPUS 2  
          ./scripts/config --set-val CONFIG_HZ 250  
          ./scripts/config --enable CONFIG_DRM_GMA500  
          ./scripts/config --enable CONFIG_R8169  
          ./scripts/config --enable CONFIG_RTL8192SE  
          ./scripts/config --enable CONFIG_SND_HDA_INTEL  
          ./scripts/config --enable CONFIG_SND_HDA_CODEC_REALTEK  
          ./scripts/config --enable CONFIG_USB_UHCI_HCD  
          ./scripts/config --enable CONFIG_USB_EHCI_HCD  
          ./scripts/config --enable CONFIG_SATA_AHCI  
          ./scripts/config --enable CONFIG_ATA_PIIX  
          ./scripts/config --enable CONFIG_X86_INTEL_LPSS  
          ./scripts/config --enable CONFIG_PMC_ATOM  
          ./scripts/config --enable CONFIG_INTEL_IDLE
          ./scripts/config --enable CONFIG_MICROCODE_INTEL
          ./scripts/config --enable CONFIG_DM_CRYPT  
          ./scripts/config --enable CONFIG_CRYPTO_XTS
          ./scripts/config --enable CONFIG_CRYPTO_AES
          ./scripts/config --enable CONFIG_KEYS
          ./scripts/config --enable CONFIG_MODULE_SIG  
          ./scripts/config --enable CONFIG_MODULE_SIG_FORCE  
          ./scripts/config --set-str CONFIG_MODULE_SIG_KEY "certs/signing_key.pem"  
          ./scripts/config --enable CONFIG_STRICT_DEVMEM  
          ./scripts/config --enable CONFIG_SECCOMP
          ./scripts/config --enable CONFIG_SECCOMP_FILTER  
          ./scripts/config --enable CONFIG_CC_STACKPROTECTOR_STRONG
          ./scripts/config --enable CONFIG_RANDOMIZE_BASE
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_BLUETOOTH
          ./scripts/config --disable CONFIG_WIRELESS
          ./scripts/config --disable CONFIG_DRM_I915

          make olddefconfig

      - name: Build kernel and modules  
        run: |  
          cd $WORKDIR/linux-${{ env.KERNEL_VERSION }}  
          cp ../certs/signing_key.pem ../certs/signing_key.x509 .  
          make -j2 bzImage
          make -j2 modules

      - name: Create final package  
        run: |  
          cd $WORKDIR/linux-${{ env.KERNEL_VERSION }}  
          VER=$(make -s kernelrelease)  
          PKG=../package  
          mkdir -p $PKG/boot $PKG/scripts $PKG/etc/systemd/resolved.conf.d  

          cp arch/x86/boot/bzImage $PKG/boot/vmlinuz-$VER  
          cp System.map $PKG/boot/System.map-$VER
          cp .config $PKG/boot/config-$VER
          make INSTALL_MOD_PATH=$PKG modules_install  
          echo "$VER" > $PKG/kernel-version.txt  

          cat > $PKG/scripts/install.sh << 'EOF'
#!/bin/bash
set -e

VER=$(cat kernel-version.txt 2>/dev/null || echo "$1")
if [ "$EUID" != "0" ]; then
    echo "Error: Ejecutar como root: sudo $0"
    exit 1
fi

echo "Instalando kernel seguro $VER con UFW y DNS cifrado..."

echo "Copiando archivos del kernel..."
cp boot/vmlinuz-$VER /boot/
cp boot/System.map-$VER /boot/
cp boot/config-$VER /boot/
cp -r lib/modules/$VER /lib/modules/
update-initramfs -c -k $VER
update-grub

echo "Configurando firewall UFW..."
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw --force enable

echo "Configurando DNS sobre TLS..."
mkdir -p /etc/systemd/resolved.conf.d
cat > /etc/systemd/resolved.conf.d/dns.conf << INNER_EOF
[Resolve]
DNS=1.1.1.1 1.0.0.1 2606:4700:4700::1111 2606:4700:4700::1001
DNSOverTLS=yes
INNER_EOF
systemctl restart systemd-resolved

echo "Instalacion completada: Kernel $VER instalado."
echo "Reinicia el sistema y selecciona el nuevo kernel en GRUB:"
echo "sudo reboot"
EOF

          cat > $PKG/scripts/uninstall.sh << 'EOF'
#!/bin/bash
set -e

VER=$(cat kernel-version.txt 2>/dev/null || echo "$1")
read -p "Eliminar kernel $VER y configuracion de seguridad? (y/N): " ans
if [ "$ans" != "y" ] && [ "$ans" != "Y" ]; then
    echo "Cancelado"
    exit 0
fi

echo "Eliminando kernel $VER..."

rm -f /boot/vmlinuz-$VER /boot/initrd.img-$VER
rm -f /boot/System.map-$VER /boot/config-$VER
rm -rf /lib/modules/$VER
update-grub

echo "Restaurando configuracion de red..."
ufw --force reset
rm -f /etc/systemd/resolved.conf.d/dns.conf
systemctl restart systemd-resolved

echo "Eliminacion completada. Reinicia el sistema."
EOF

          chmod +x $PKG/scripts/*.sh  
          cd .. && tar czf atom-n2600-kernel-${{ env.KERNEL_VERSION }}.tar.gz package

      - name: Upload kernel package  
        uses: actions/upload-artifact@v4  
        with:  
          name: atom-n2600-kernel-${{ env.KERNEL_VERSION }}  
          path: ${{ env.WORKDIR }}/atom-n2600-kernel-${{ env.KERNEL_VERSION }}.tar.gz
          retention-days: 30
