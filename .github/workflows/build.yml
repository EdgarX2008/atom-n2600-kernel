name: Atom N2600 - Kernel Final Limpio y Perfecto

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version'
        required: true
        default: '6.1.113'

env:
  WORKDIR: ${{ github.workspace }}/kernel-build

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - name: Instalar dependencias
        run: |
          sudo apt update && sudo apt install -y \
            build-essential bc bison flex libncurses-dev \
            libssl-dev libelf-dev dwarves openssl xz-utils \
            cpio wget git kmod

      - name: Configurar variables
        run: |
          echo "KERNEL_VERSION=${{ github.event.inputs.kernel_version || '6.1.113' }}" >> $GITHUB_ENV
          echo "WORKDIR=${{ github.workspace }}/kernel-build" >> $GITHUB_ENV

      - name: Descargar kernel
        run: |
          mkdir -p $WORKDIR && cd $WORKDIR
          wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KERNEL_VERSION.tar.xz
          tar xf linux-$KERNEL_VERSION.tar.xz

      - name: Generar clave de firma efÃ­mera
        run: |
          cd $WORKDIR
          mkdir -p certs
          openssl req -new -x509 -newkey rsa:2048 \
            -keyout certs/signing_key.pem \
            -out certs/signing_key.x509 \
            -nodes -days 1 -subj "/CN=Atom N2600"

      - name: Configurar kernel para Atom N2600
        run: |
          cd $WORKDIR/linux-$KERNEL_VERSION
          make defconfig

          # ConfiguraciÃ³n especÃ­fica para Atom N2600
          ./scripts/config --set-str CONFIG_LOCALVERSION "-atom-n2600-final"
          ./scripts/config --enable CONFIG_MATOM
          ./scripts/config --set-val CONFIG_NR_CPUS 2
          ./scripts/config --set-val CONFIG_HZ 250

          # Drivers grÃ¡ficos GMA500 (CRÃTICO)
          ./scripts/config --module CONFIG_DRM_GMA500
          ./scripts/config --enable CONFIG_DRM
          ./scripts/config --enable CONFIG_DRM_KMS_HELPER
          ./scripts/config --enable CONFIG_FB
          ./scripts/config --enable CONFIG_FRAMEBUFFER_CONSOLE
          ./scripts/config --enable CONFIG_BACKLIGHT_CLASS_DEVICE
          ./scripts/config --enable CONFIG_BACKLIGHT_LCD_SUPPORT

          # Drivers de red y audio
          ./scripts/config --enable CONFIG_R8169
          ./scripts/config --module CONFIG_RTL8192SE
          ./scripts/config --enable CONFIG_SND_HDA_INTEL
          ./scripts/config --enable CONFIG_SND_HDA_CODEC_REALTEK

          # USB y SATA
          ./scripts/config --enable CONFIG_USB_UHCI_HCD
          ./scripts/config --enable CONFIG_USB_EHCI_HCD
          ./scripts/config --enable CONFIG_SATA_AHCI

          # Hardware especÃ­fico Atom
          ./scripts/config --enable CONFIG_PMC_ATOM
          ./scripts/config --enable CONFIG_X86_PLATFORM_DEVICES
          ./scripts/config --enable CONFIG_ACPI

          # Hardening de seguridad
          ./scripts/config --enable CONFIG_MODULE_SIG
          ./scripts/config --enable CONFIG_MODULE_SIG_FORCE
          ./scripts/config --set-str CONFIG_MODULE_SIG_KEY "certs/signing_key.pem"
          ./scripts/config --enable CONFIG_CC_STACKPROTECTOR_STRONG
          ./scripts/config --enable CONFIG_RANDOMIZE_BASE
          ./scripts/config --enable CONFIG_SECCOMP_FILTER
          ./scripts/config --enable CONFIG_STRICT_DEVMEM
          
          # OptimizaciÃ³n de tamaÃ±o
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_X86_DECODER_SELFTEST

          make olddefconfig

      - name: Compilar kernel
        run: |
          cd $WORKDIR/linux-$KERNEL_VERSION
          cp ../certs/signing_key.pem ../certs/signing_key.x509 .
          make -j2

      - name: Compilar mÃ³dulos
        run: |
          cd $WORKDIR/linux-$KERNEL_VERSION
          make -j2 modules

      - name: Empaquetar kernel
        run: |
          cd $WORKDIR/linux-$KERNEL_VERSION
          KERNEL_RELEASE=$(make -s kernelrelease)
          mkdir -p ../package/{boot,scripts,lib/modules}

          cp arch/x86/boot/bzImage ../package/boot/vmlinuz-$KERNEL_RELEASE
          make INSTALL_MOD_PATH=../package modules_install
          echo "$KERNEL_RELEASE" > ../package/kernel-version.txt

          # Script de instalaciÃ³n mejorado
          cat > ../package/scripts/install.sh << 'EOF'
#!/bin/bash
set -e

VER=$(cat /tmp/kernel-package/kernel-version.txt)
[ "$EUID" -ne 0 ] && { 
  echo "Ejecutar como root:sudo $0" 
  exit 1
}

echo "=== Instalando kernel Atom N2600 $VER ==="

# Copiar kernel
cp /tmp/kernel-package/boot/vmlinuz-$VER /boot/

# Copiar mÃ³dulos
cp -r /tmp/kernel-package/lib/modules/$VER /lib/modules/

# Configurar mÃ³dulo GMA500
echo "gma500_gfx" > /etc/modules-load.d/gma500.conf

# Crear initramfs
update-initramfs -c -k $VER

# Configurar GRUB
update-grub

echo "âœ… Â¡InstalaciÃ³n completada!"
echo "ðŸ“ Reinicia y selecciona: 'Ubuntu, with Linux $VER' en GRUB"
echo "ðŸ’» Para cargar grÃ¡ficos: 'modprobe gma500_gfx'"
EOF

          chmod +x ../package/scripts/install.sh

          # Crear README
          cat > ../package/README.md << 'EOF'
# Kernel Linux para Atom N2600

**VersiÃ³n**: $KERNEL_RELEASE
**Optimizado para**: Intel Atom N2600 con GMA500

## InstalaciÃ³n:

1. Extraer todo en /tmp/kernel-package/
2. Ejecutar: `sudo /tmp/kernel-package/scripts/install.sh`
3. Reiniciar y seleccionar el nuevo kernel en GRUB

## Drivers incluidos:
- GMA500 graphics (mÃ³dulo gma500_gfx)
- Realtek R8169 Ethernet
- Realtek RTL8192SE WiFi
- HD Audio
- USB UHCI/EHCI
- SATA AHCI

EOF

          cd .. && tar czf atom-n2600-final-$KERNEL_VERSION.tar.gz package

      - name: Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: atom-n2600-kernel-${{ env.KERNEL_VERSION }}
          path: ${{ env.WORKDIR }}/atom-n2600-final-*.tar.gz
