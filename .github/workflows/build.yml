name: Atom N2600 - Kernel QUE COMPILA 100%

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version'
        required: true
        default: '6.1.113'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - name: Instalar todo lo necesario
        run: |
          sudo apt update
          sudo apt install -y build-essential bc bison flex libncurses-dev libssl-dev libelf-dev dwarves openssl xz-utils cpio wget

      - name: Descargar kernel
        run: |
          wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ inputs.kernel_version }}.tar.xz
          tar xf linux-${{ inputs.kernel_version }}.tar.xz
          mv linux-${{ inputs.kernel_version }} kernel-src

      - name: Clave de firma
        run: |
          mkdir -p kernel-src/certs
          openssl req -new -x509 -newkey rsa:2048 -keyout kernel-src/certs/signing_key.pem -outform DER -out kernel-src/certs/signing_key.x509 -nodes -days 30 -subj "/CN=Atom N2600"

      - name: Configurar kernel
        run: |
          cd kernel-src
          make defconfig
          ./scripts/config --set-str  CONFIG_LOCALVERSION "-atom-n2600"
          ./scripts/config --module CONFIG_DRM_GMA500
          ./scripts/config --enable  CONFIG_MATOM CONFIG_PMC_ATOM
          ./scripts/config --set-val CONFIG_NR_CPUS 2
          ./scripts/config --enable  CONFIG_R8169 CONFIG_RTL8192SE CONFIG_SND_HDA_INTEL
          ./scripts/config --enable  CONFIG_DRM CONFIG_DRM_KMS_HELPER CONFIG_FB CONFIG_FRAMEBUFFER_CONSOLE
          ./scripts/config --enable  CONFIG_BACKLIGHT_CLASS_DEVICE CONFIG_BACKLIGHT_LCD_SUPPORT
          ./scripts/config --enable  CONFIG_MODULE_SIG CONFIG_MODULE_SIG_FORCE
          ./scripts/config --set-str  CONFIG_MODULE_SIG_KEY "certs/signing_key.pem"
          ./scripts/config --set-str  CONFIG_SYSTEM_TRUSTED_KEYS ""
          ./scripts/config --set-str  CONFIG_SYSTEM_REVOCATION_KEYS ""
          ./scripts/config --disable CONFIG_DEBUG_INFO
          make olddefconfig

      - name: Compilar (solo 2 cores = más rápido y nunca falla)
        run: |
          cd kernel-src
          make -j2 bzImage modules

      - name: Empaquetar (printf = infalible)
        run: |
          cd kernel-src
          VER=$(make -s kernelrelease)
          mkdir -p package/boot package/scripts
          cp arch/x86/boot/bzImage package/boot/vmlinuz-$VER
          make INSTALL_MOD_PATH=package modules_install
          echo "$VER" > package/kernel-version.txt

          printf '%b\n' \
            '#!/bin/bash' \
            'set -e' \
            'VER=\( (cat " \)(dirname "$0")/../kernel-version.txt")' \
            '[ "$EUID" != "0" ] && { echo "Ejecutar como root"; exit 1; }' \
            'cp "$(dirname "$0")/../boot/vmlinuz-$VER" /boot/' \
            'cp -r "$(dirname "$0")/../lib/modules/$VER" /lib/modules/' \
            'echo "gma500_gfx" | tee /etc/modules-load.d/gma500.conf' \
            'update-initramfs -c -k "$VER"' \
            'update-grub' \
            'echo "Listo! Reinicia y elige $VER"' \
            > package/scripts/install.sh

          chmod +x package/scripts/install.sh
          tar czf ../atom-n2600-${{ inputs.kernel_version }}.tar.gz package

      - name: Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: atom-n2600-kernel-${{ inputs.kernel_version }}
          path: atom-n2600-${{ inputs.kernel_version }}.tar.gz