name: Atom N2600 - Kernel Final con LUKS/Cryptsetup

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version'
        required: true
        default: '6.1.113'

env:
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  WORKDIR: ${{ github.workspace }}/kernel-build

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - name: Instalar dependencias
        run: |
          sudo apt update && sudo apt install -y \
            build-essential bc bison flex libncurses-dev \
            libssl-dev libelf-dev dwarves openssl xz-utils \
            cpio wget git kmod cryptsetup

      - name: Descargar kernel
        run: |
          mkdir -p ${{ env.WORKDIR }} && cd ${{ env.WORKDIR }}
          wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz
          tar xf linux-${{ env.KERNEL_VERSION }}.tar.xz

      - name: Generar clave de firma efímera
        run: |
          cd ${{ env.WORKDIR }}
          mkdir -p certs
          openssl req -new -x509 -newkey rsa:2048 \
            -keyout certs/signing_key.pem \
            -out certs/signing_key.x509 \
            -nodes -days 1 -subj "/CN=Atom N2600"

      - name: Configurar kernel para Atom N2600 + LUKS
        run: |
          cd ${{ env.WORKDIR }}/linux-${{ env.KERNEL_VERSION }}
          make defconfig
          
          ./scripts/config --set-str CONFIG_LOCALVERSION "-atom-n2600-luks"
          ./scripts/config --enable CONFIG_MATOM
          ./scripts/config --set-val CONFIG_NR_CPUS 2
          ./scripts/config --set-val CONFIG_HZ 250
          
          # Gráficos GMA500
          ./scripts/config --module CONFIG_DRM_GMA500
          ./scripts/config --enable CONFIG_DRM
          ./scripts/config --enable CONFIG_DRM_KMS_HELPER
          ./scripts/config --enable CONFIG_FB
          ./scripts/config --enable CONFIG_FRAMEBUFFER_CONSOLE
          ./scripts/config --enable CONFIG_BACKLIGHT_CLASS_DEVICE
          ./scripts/config --enable CONFIG_BACKLIGHT_LCD_SUPPORT
          
          # Red y Audio
          ./scripts/config --enable CONFIG_R8169
          ./scripts/config --module CONFIG_RTL8192SE
          ./scripts/config --enable CONFIG_SND_HDA_INTEL
          ./scripts/config --enable CONFIG_SND_HDA_CODEC_REALTEK
          
          # USB y SATA
          ./scripts/config --enable CONFIG_USB_UHCI_HCD
          ./scripts/config --enable CONFIG_USB_EHCI_HCD
          ./scripts/config --enable CONFIG_SATA_AHCI
          
          # Plataforma Atom
          ./scripts/config --enable CONFIG_PMC_ATOM
          ./scripts/config --enable CONFIG_X86_PLATFORM_DEVICES
          ./scripts/config --enable CONFIG_ACPI
          
          # ===== SOPORTE COMPLETO PARA LUKS/CRYPTSETUP =====
          
          # Device Mapper (base para LUKS)
          ./scripts/config --enable CONFIG_BLK_DEV_DM
          ./scripts/config --enable CONFIG_DM_CRYPT
          ./scripts/config --enable CONFIG_DM_INTEGRITY
          
          # Algoritmos de encriptación para LUKS1 y LUKS2
          ./scripts/config --enable CONFIG_CRYPTO_AES
          ./scripts/config --enable CONFIG_CRYPTO_AES_X86_64
          ./scripts/config --enable CONFIG_CRYPTO_XTS
          ./scripts/config --enable CONFIG_CRYPTO_CBC
          ./scripts/config --enable CONFIG_CRYPTO_ECB
          ./scripts/config --enable CONFIG_CRYPTO_LRW
          ./scripts/config --enable CONFIG_CRYPTO_PCBC
          
          # Algoritmos de hash para LUKS
          ./scripts/config --enable CONFIG_CRYPTO_SHA256
          ./scripts/config --enable CONFIG_CRYPTO_SHA512
          ./scripts/config --enable CONFIG_CRYPTO_SHA1
          ./scripts/config --enable CONFIG_CRYPTO_HMAC
          ./scripts/config --enable CONFIG_CRYPTO_PBKDF2
          
          # Modos de encriptación avanzados (LUKS2)
          ./scripts/config --enable CONFIG_CRYPTO_ESSIV
          ./scripts/config --enable CONFIG_CRYPTO_AUTHENC
          ./scripts/config --enable CONFIG_CRYPTO_GCM
          ./scripts/config --enable CONFIG_CRYPTO_CTR
          
          # Serpent, Twofish (algoritmos opcionales LUKS)
          ./scripts/config --enable CONFIG_CRYPTO_SERPENT
          ./scripts/config --enable CONFIG_CRYPTO_TWOFISH
          ./scripts/config --enable CONFIG_CRYPTO_TWOFISH_X86_64
          
          # Más algoritmos comunes
          ./scripts/config --enable CONFIG_CRYPTO_BLOWFISH
          ./scripts/config --enable CONFIG_CRYPTO_CAST5
          ./scripts/config --enable CONFIG_CRYPTO_CAST6
          
          # Random Number Generator (importante para cryptsetup)
          ./scripts/config --enable CONFIG_CRYPTO_USER_API_HASH
          ./scripts/config --enable CONFIG_CRYPTO_USER_API_SKCIPHER
          ./scripts/config --enable CONFIG_HW_RANDOM
          
          # Soporte para initramfs con LUKS
          ./scripts/config --enable CONFIG_BLK_DEV_INITRD
          ./scripts/config --enable CONFIG_RD_GZIP
          ./scripts/config --enable CONFIG_RD_BZIP2
          ./scripts/config --enable CONFIG_RD_LZMA
          ./scripts/config --enable CONFIG_RD_XZ
          ./scripts/config --enable CONFIG_RD_LZ4
          
          # ===== FIN SOPORTE LUKS =====
          
          # Seguridad
          ./scripts/config --enable CONFIG_MODULE_SIG
          ./scripts/config --enable CONFIG_MODULE_SIG_FORCE
          ./scripts/config --set-str CONFIG_MODULE_SIG_KEY "certs/signing_key.pem"
          ./scripts/config --enable CONFIG_CC_STACKPROTECTOR_STRONG
          ./scripts/config --enable CONFIG_RANDOMIZE_BASE
          ./scripts/config --enable CONFIG_SECCOMP_FILTER
          ./scripts/config --enable CONFIG_STRICT_DEVMEM
          
          # Desactivar debug
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_X86_DECODER_SELFTEST
          
          make olddefconfig

      - name: Compilar kernel y módulos
        run: |
          cd ${{ env.WORKDIR }}/linux-${{ env.KERNEL_VERSION }}
          cp ../certs/signing_key.pem ../certs/signing_key.x509 .
          make -j2 bzImage modules

      - name: Empaquetar kernel
        run: |
          cd ${{ env.WORKDIR }}/linux-${{ env.KERNEL_VERSION }}
          KERNEL_RELEASE=$(make -s kernelrelease)
          mkdir -p ../package/boot ../package/scripts ../package/lib/modules
          
          cp arch/x86/boot/bzImage ../package/boot/vmlinuz-$KERNEL_RELEASE
          cp System.map ../package/boot/System.map-$KERNEL_RELEASE
          cp .config ../package/boot/config-$KERNEL_RELEASE
          make INSTALL_MOD_PATH=../package modules_install
          echo "$KERNEL_RELEASE" > ../package/kernel-version.txt
          
          cat > ../package/scripts/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          set -e
          
          VER=$(cat kernel-version.txt 2>/dev/null)
          [ -z "$VER" ] && { echo "Error: No se encontró kernel-version.txt"; exit 1; }
          [ "$EUID" -ne 0 ] && { echo "Ejecutar como root: sudo $0"; exit 1; }
          
          echo "=== Instalando kernel Atom N2600 con soporte LUKS $VER ==="
          
          cp boot/vmlinuz-$VER /boot/
          [ -f boot/System.map-$VER ] && cp boot/System.map-$VER /boot/
          [ -f boot/config-$VER ] && cp boot/config-$VER /boot/
          
          cp -r lib/modules/$VER /lib/modules/
          
          mkdir -p /etc/modules-load.d
          echo "gma500_gfx" > /etc/modules-load.d/gma500.conf
          
          echo "Generando initramfs con soporte LUKS..."
          update-initramfs -c -k $VER
          
          echo "Actualizando GRUB..."
          update-grub
          
          echo ""
          echo "✓ Instalacion completada"
          echo "✓ Soporte LUKS/cryptsetup habilitado"
          echo ""
          echo "Reinicia y selecciona Ubuntu con Linux $VER en GRUB"
          echo "El driver gma500_gfx se cargara automaticamente"
          echo ""
          echo "Para verificar soporte LUKS despues del reinicio:"
          echo "  cryptsetup --version"
          echo "  lsmod | grep dm_crypt"
          echo ""
          INSTALL_EOF
          
          chmod +x ../package/scripts/install.sh
          
          cat > ../package/README.md << README_EOF
          # Kernel Linux para Atom N2600 con LUKS/Cryptsetup
          
          **Version**: $KERNEL_RELEASE
          **Optimizado para**: Intel Atom N2600 con GMA500
          **Soporte de encriptación**: LUKS1/LUKS2 completo
          
          ## Instalacion:
          
          1. Extraer el archivo tar.gz
          2. Ejecutar: sudo ./scripts/install.sh
          3. Reiniciar y seleccionar el nuevo kernel en GRUB
          
          ## Drivers incluidos:
          - GMA500 graphics (modulo gma500_gfx)
          - Realtek R8169 Ethernet
          - Realtek RTL8192SE WiFi
          - HD Audio
          - USB UHCI/EHCI
          - SATA AHCI
          
          ## Soporte de encriptación LUKS:
          - Device Mapper (dm-crypt)
          - LUKS1 y LUKS2
          - Algoritmos: AES, XTS, CBC, Serpent, Twofish
          - Hash: SHA256, SHA512, SHA1
          - Soporte completo para cryptsetup
          - Compatible con discos encriptados en boot
          
          ## Uso de LUKS:
          
          ### Encriptar una partición:
          \`\`\`bash
          sudo cryptsetup luksFormat /dev/sdX
          sudo cryptsetup luksOpen /dev/sdX mi_disco
          sudo mkfs.ext4 /dev/mapper/mi_disco
          \`\`\`
          
          ### Montar partición encriptada:
          \`\`\`bash
          sudo cryptsetup luksOpen /dev/sdX mi_disco
          sudo mount /dev/mapper/mi_disco /mnt
          \`\`\`
          
          ### Desmontar:
          \`\`\`bash
          sudo umount /mnt
          sudo cryptsetup luksClose mi_disco
          \`\`\`
          
          ## Notas importantes:
          - El driver GMA500 esta compilado como MODULO (no built-in)
          - Se carga automaticamente en el boot
          - El initramfs incluye los modulos dm-crypt necesarios
          - Compatible con root filesystem encriptado
          
          ## Seguridad:
          - Modulos firmados digitalmente
          - Stack protector strong
          - ASLR habilitado
          - Seccomp filter
          - Memoria estricta
          - Soporte completo para encriptación de disco
          
          ## Verificar soporte LUKS:
          \`\`\`bash
          # Ver módulos cargados
          lsmod | grep dm_crypt
          
          # Verificar cryptsetup
          cryptsetup --version
          
          # Ver algoritmos disponibles
          cat /proc/crypto
          \`\`\`
          README_EOF
          
          cd .. && tar czf atom-n2600-luks-${{ env.KERNEL_VERSION }}.tar.gz package

      - name: Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: atom-n2600-kernel-luks-${{ env.KERNEL_VERSION }}
          path: ${{ env.WORKDIR }}/atom-n2600-luks-${{ env.KERNEL_VERSION }}.tar.gz